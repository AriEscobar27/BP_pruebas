- name: "Prueba"
  hosts: all
  gather_facts: true
  vars: 
    aix_reports_path: /tmp
    
  tasks:
  - name: "Definir hechos para Reporte"
    ansible.builtin.set_fact:
      aix_report_pre_patch: "{{ ansible_hostname }}_{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}{{ ansible_date_time.second }}_{{ tower_job_id }}_PRE.txt"

  - name: "Tomar evidencias previas al parchado"
    ansible.builtin.include_tasks:
      file: generar_status_aix.yaml
    vars:
      aix_report_file: "{{ aix_report_pre_patch }}"
      
  - name: "Definir hechos - Parte 1"
    ansible.builtin.set_stats:
      data:
        success_list: '{{ hostvars | dict2items | json_query(success_query) }}' 
      per_host: false
    vars:
      success_query: "[?value.job_success==`true`].key"
      
  - name: "Definir hechos - Parte 2"
    ansible.builtin.set_stats:
      data:
        aix_report_pre_patch: "{{ ansible_hostname }}_{{ ansible_date_time.date }}_{{ ansible_date_time.hour  }}{{ ansible_date_time.minute }}{{ ansible_date_time.second  }}_{{ tower_job_id }}_PRE.txt"
      per_host: true
      aggregate: false
